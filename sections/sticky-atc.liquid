{% if section.settings.enable %}
<div class="sticky-atc-wrapper" id="sticky-atc">
  <div class="sticky-atc-pill">
    {% if section.settings.show_image %}
      <div class="sticky-atc-image">
        <img src="{{ product.featured_image | image_url: width: 120 }}" width="50" height="50" alt="{{ product.title | escape }}">
      </div>
    {% endif %}
    
    <div class="sticky-atc-info">
      <div class="sticky-atc-title">{{ product.title | truncate: 18 }}</div>
      <div class="sticky-atc-price">{{ product.price | money }}</div>
    </div>

    <div class="sticky-atc-action">
       <button type="button" class="btn-sticky-add" id="btn-sticky-add">
         Add to Cart
       </button>
    </div>
  </div>
</div>

<style>
/* Floating Pill Design */
.sticky-atc-wrapper {
  position: fixed;
  bottom: 90px; /* Adjusted to sit ABOVE the mobile bottom nav bar */
  left: 0;
  width: 100%;
  pointer-events: none; /* Let clicks pass through outside the pill */
  z-index: 1000; /* Ensure it stays on top */
  display: flex;
  justify-content: center;
  align-items: flex-end;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
}

.sticky-atc-wrapper.visible {
  opacity: 1;
  transform: translateY(0);
}

.sticky-atc-pill {
  pointer-events: auto;
  display: flex;
  align-items: center;
  gap: 12px;
  background: rgba(255, 255, 255, 0.9); /* Slightly more opaque */
  backdrop-filter: blur(12px); /* Glassmorphism */
  -webkit-backdrop-filter: blur(12px);
  padding: 8px 12px 8px 8px; /* Less padding left for image */
  border-radius: 50px;
  box-shadow: 
    0 10px 30px -10px rgba(0,0,0,0.15),
    0 4px 10px rgba(0,0,0,0.05),
    inset 0 0 0 1px rgba(255,255,255,0.6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  width: auto;
  max-width: 90%;
  margin: 0 auto;
}

.sticky-atc-image img {
  width: 44px;
  height: 44px;
  border-radius: 50%; /* Circle image */
  object-fit: cover;
  display: block;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.sticky-atc-info {
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0; /* Text truncation handling */
  margin-right: 4px;
}

.sticky-atc-title {
  font-size: 13px;
  font-weight: 600;
  color: #1a1a1a;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 140px;
  line-height: 1.2;
}

.sticky-atc-price {
  font-size: 12px;
  color: #555;
  font-weight: 500;
  line-height: 1.2;
}

.sticky-atc-action .btn-sticky-add {
  background: #000; /* Or theme primary color via settings */
  color: #fff;
  border: none;
  border-radius: 20px;
  padding: 8px 20px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  white-space: nowrap;
}

.sticky-atc-action .btn-sticky-add:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.sticky-atc-action .btn-sticky-add:active {
  transform: scale(0.95);
}

/* Tablet/Desktop tweaks */
@media screen and (min-width: 768px) {
  .sticky-atc-wrapper {
    bottom: 30px; /* Reset for desktop */
  }
  .sticky-atc-pill {
    padding: 10px 16px 10px 10px;
    gap: 16px;
  }
  .sticky-atc-image img {
    width: 50px;
    height: 50px;
  }
  .sticky-atc-title {
    font-size: 15px;
    max-width: 200px;
  }
  .sticky-atc-price {
    font-size: 13px;
  }
  .sticky-atc-action .btn-sticky-add {
    font-size: 14px;
    padding: 10px 24px;
  }
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const stickyBar = document.getElementById('sticky-atc');
    const stickyBtn = document.getElementById('btn-sticky-add');
    if (!stickyBar || !stickyBtn) return;

    // Trigger on main Add to Cart button
    const triggerElement = document.getElementById('btn-add-to-cart') || document.querySelector('.product-form'); 
    
    if (triggerElement) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          // Logic: Show sticky bar WHENEVER the main button is NOT on screen
          // This includes when it's below the fold (initial load) or scrolled past.
          if (!entry.isIntersecting) {
            stickyBar.classList.add('visible');
          } else {
            stickyBar.classList.remove('visible');
          }
        });
      }, { threshold: 0 }); // Trigger immediately when even 1px is visible/hidden
      
      observer.observe(triggerElement);
    } else {
      // Fallback
      stickyBar.classList.add('visible');
    }

    // Add to Cart Logic
    stickyBtn.addEventListener('click', (e) => {
      e.preventDefault();
      
      const mainAtc = document.getElementById('btn-add-to-cart') || document.querySelector('button[name="add"]');
      
      if (mainAtc) {
        mainAtc.click();
        
        // Feedback animation
        const originalText = stickyBtn.textContent;
        stickyBtn.textContent = 'Adding...';
        setTimeout(() => {
           stickyBtn.textContent = originalText;
        }, 1000);
      } else {
        const form = document.getElementById('product-form-installment') || document.querySelector('form[action="/cart/add"]');
        if (form) form.submit();
      }
    });
  });
</script>
{% endif %}

{% schema %}
{
  "name": "Sticky ATC",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable",
      "label": "Enable Sticky ATC",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "label": "Show Product Image",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Sticky ATC"
    }
  ]
}
{% endschema %}
