<div class="product-section section-{{ section.id }}-padding" id="MainProduct-{{ section.id }}">
  <div class="container product-container">
    <div class="product-layout">
      
      <!-- LEFT: Media Gallery -->
      <div class="product-media-wrapper">
         <div class="product-media-main">
            {%- if product.selected_or_first_available_variant.featured_media != null -%}
              {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
            {%- else -%}
              {%- assign featured_media = product.featured_media -%}
            {%- endif -%}
            
            <img src="{{ featured_media | image_url: width: 1200 }}" 
                 alt="{{ featured_media.alt | escape }}" 
                 id="MainImage-{{ section.id }}" 
                 class="main-image"
                 loading="eager" width="1200">
         </div>
         
         {%- if product.media.size > 1 -%}
           <div class="product-thumbnails">
              {%- for media in product.media -%}
                <div class="thumbnail-item {% if media.id == featured_media.id %}active{% endif %}"
                     onclick="changeMainImage('{{ media | image_url: width: 1200 }}', this)">
                   <img src="{{ media | image_url: width: 100 }}" alt="{{ media.alt | escape }}" width="100" height="100">
                </div>
              {%- endfor -%}
           </div>
         {%- endif -%}
      </div>

      <!-- RIGHT: Info Column -->
      <div class="product-info-wrapper">
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            
            <!-- Title & Rating -->
            {%- when 'title' -%}
              <div class="product-block-title" {{ block.shopify_attributes }}>
                <h1 class="product-title h2">{{ product.title }}</h1>
                <div class="product-rating-row">
                   <div class="rating-stars">
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_half' %}
                   </div>
                   <span class="rating-count">4.9 (Verified)</span>
                </div>
              </div>

            <!-- Price -->
            {%- when 'price' -%}
              <div class="product-block-price" {{ block.shopify_attributes }}>
                 <div class="price-container">
                    <span class="price-currency">AED</span>
                    <span class="price-current">{{ product.price | money_without_currency }}</span>
                    
                    {%- assign compare_price = product.compare_at_price -%}
                    {%- assign product_price = product.price -%}
                    
                    {%- if compare_price > product_price -%}
                        <!-- Real Discount -->
                        <span class="price-original">{{ compare_price | money_without_currency }}</span>
                        {%- assign discount = compare_price | minus: product_price | times: 100.0 | divided_by: compare_price | round -%}
                        <span class="discount-badge">{{ discount }}% Off</span>
                    {%- else -%}
                        <!-- Artificial 10% Discount logic -->
                        {%- assign fake_original = product_price | times: 1.1 | round -%}
                        <span class="price-original" style="opacity: 0.5;">{{ fake_original | money_without_currency }}</span>
                        <span class="discount-badge">10% Off</span>
                    {%- endif -%}
                 </div>
              </div>

            <!-- Variant Picker (Color) -->
            {%- when 'variant_picker' -%}
               {%- unless product.has_only_default_variant -%}
                 <div class="product-variant-picker" {{ block.shopify_attributes }}>
                    {%- for option in product.options_with_values -%}
                       {%- assign option_name_downcase = option.name | downcase -%}
                       {%- if option_name_downcase contains 'ships from' and block.settings.enable_ships_from == false -%}
                          {%- continue -%}
                       {%- endif -%}

                       <fieldset class="js product-form__input">
                          <legend class="form__label">{{ option.name }}</legend>
                          <div class="variant-options">
                             {%- for value in option.values -%}
                                <label class="variant-pill {% if option_name_downcase contains 'color' and block.settings.color_style == 'circle' %}variant-circle{% endif %}"
                                       {% if option_name_downcase contains 'color' and block.settings.color_style == 'circle' %}
                                         {% assign color_swatch = value | split: '-' | first | split: ' ' | first | downcase %}
                                         style="--swatch-color: {{ color_swatch }};"
                                         title="{{ value }}"
                                       {% endif %}
                                >
                                   <input type="radio" name="{{ option.name }}" value="{{ value | escape }}" {% if option.selected_value == value %}checked{% endif %} 
                                          onchange="/* logic to update variant id */">
                                   {% if option_name_downcase contains 'color' and block.settings.color_style == 'circle' %}
                                      <span class="circle-swatch"></span>
                                   {% else %}
                                      <span>{{ value }}</span>
                                   {% endif %}
                                </label>
                             {%- endfor -%}
                          </div>
                       </fieldset>
                    {%- endfor -%}
                 </div>
               {%- endunless -%}

            <!-- Description/Specs now moved to bottom, so we skip here -->
            {%- when 'description' -%}
            {%- when 'specifications' -%}

            <!-- Bundle Selector (Restored) -->
            {%- when 'bundle_selector' -%}
              <div class="bundle-selector" {{ block.shopify_attributes }}
                   data-tier2-qty="2" 
                   data-tier2-code="{{ block.settings.tier_2_code | escape }}"
                   data-tier3-qty="3" 
                   data-tier3-code="{{ block.settings.tier_3_code | escape }}">
                   
                 <h3 class="h4" style="font-size: 1rem; margin-bottom: 0.5rem;">Select Quantity</h3>
                 
                 <input type="hidden" name="quantity" value="1" form="product-form-installment" id="bundle-qty-hidden">
                 
                 <div class="bundle-options">
                   <!-- Tier 1: Buy 1 -->
                   <label class="bundle-option active" onclick="selectBundle(1, this)">
                     <span class="radio-circle"></span>
                     <div class="bundle-details">
                       <span class="bundle-title">Buy 1</span>
                       <span class="bundle-price">{{ product.price | money }}/each</span>
                     </div>
                   </label>
                   
                   <!-- Tier 2 -->
                   {%- assign t2_pct = block.settings.tier_2_percent | default: 10 -%}
                   {%- assign t2_mult = 100.0 | minus: t2_pct | divided_by: 100.0 -%}
                   {%- assign t2_price = product.price | times: t2_mult -%}
                   
                   <label class="bundle-option" onclick="selectBundle(2, this)">
                     <span class="radio-circle"></span>
                     <div class="bundle-details">
                       <div class="flex-between">
                         <span class="bundle-title">Buy 2 & Save {{ t2_pct }}%</span>
                         <span class="badge-best-seller">Best Seller</span>
                       </div>
                       <span class="bundle-price">{{ t2_price | money }}/each</span>
                     </div>
                   </label>
                   
                   <!-- Tier 3 -->
                   {%- assign t3_pct = block.settings.tier_3_percent | default: 20 -%}
                   {%- assign t3_mult = 100.0 | minus: t3_pct | divided_by: 100.0 -%}
                   {%- assign t3_price = product.price | times: t3_mult -%}
                   
                   <label class="bundle-option" onclick="selectBundle(3, this)">
                     <span class="radio-circle"></span>
                     <div class="bundle-details">
                       <span class="bundle-title">Buy 3 & Save {{ t3_pct }}%</span>
                       <span class="bundle-price">{{ t3_price | money }}/each</span>
                     </div>
                   </label>
                 </div>
              </div>

            <!-- Buy Actions -->
            {%- when 'buy_buttons' -%}
               <div class="product-block-actions" {{ block.shopify_attributes }}>
                 {% form 'product', product, id: 'product-form-installment', class: 'product-form' %}
                   <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                   <!-- Quantity handled by Bundle Selector via form attribute -->

                   <!-- Buttons -->
                   <div class="action-buttons">
                     <button type="submit" name="add" class="btn-atc-pill" id="btn-add-to-cart">
                       Add to Cart
                     </button>
                     <button type="submit" name="add" class="btn-buy-now" id="btn-buy-now">
                       Buy Now
                     </button>
                   </div>
                 {% endform %}
               </div>

            <!-- Trust Badges -->
            {%- when 'trust_icons' -%}
               <div class="product-trust-row" {{ block.shopify_attributes }}>
                 <div class="trust-item">
                    <span class="trust-icon">üöö</span>
                    <span class="trust-text">Free Shipment</span>
                 </div>
                 <div class="trust-item">
                    <span class="trust-icon">‚Ü©Ô∏è</span>
                    <span class="trust-text">30 Days Return</span>
                 </div>
                 <div class="trust-item">
                    <span class="trust-icon">üõ°Ô∏è</span>
                    <span class="trust-text">24/7 Support</span>
                 </div>
               </div>

             <!-- Custom Liquid Block -->
             {%- when 'custom_liquid' -%}
                <div class="product-custom-liquid" {{ block.shopify_attributes }}>
                   {{ block.settings.custom_liquid }}
                </div>

          {%- endcase -%}
        {%- endfor -%}
      </div>
    
    </div>

    <!-- BOTTOM: Detailed Information (Full Width) -->
    <div class="product-bottom-accordions">
       {%- for block in section.blocks -%}
          {%- case block.type -%}
             <!-- Description Accordion -->
             {%- when 'description' -%}
               <details class="product-accordion" {{ block.shopify_attributes }}>
                 <summary class="accordion-header">
                    <span class="accordion-title">Product Specifications</span>
                    <span class="accordion-icon">+</span>
                 </summary>
                 <div class="accordion-content rte">
                   {{ product.description }}
                 </div>
               </details>

             <!-- Specs Accordion -->
             {%- when 'specifications' -%}
               <details class="product-accordion" {{ block.shopify_attributes }}>
                  <summary class="accordion-header">
                    <span class="accordion-title">Additional Information</span>
                    <span class="accordion-icon">+</span>
                  </summary>
                  <div class="accordion-content">
                    <ul class="specs-list">
                      <li><strong>Product Name:</strong> {{ product.title }}</li>
                      <li><strong>SKU:</strong> {{ product.selected_or_first_available_variant.sku | default: 'N/A' }}</li>
                      <li><strong>Stock:</strong> {% if product.available %}In Stock{% else %}Out of Stock{% endif %}</li>
                    </ul>
                  </div>
               </details>
          {%- endcase -%}
       {%- endfor -%}
    </div>
  </div>
</div>

<script>
  function changeMainImage(src, el) {
    document.getElementById('MainImage-{{ section.id }}').src = src;
    document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  }

  function selectBundle(qty, element) {
    /* Visual */
    document.querySelectorAll('.bundle-option').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    /* Logic: Update hidden input linked to form */
    const input = document.getElementById('bundle-qty-hidden');
    if(input) input.value = qty;
  }
  
  /* Variant Selection Handler (Simple) */
  document.addEventListener('DOMContentLoaded', function() {
     const variantInputs = document.querySelectorAll('.product-variant-picker input[type="radio"]');
     variantInputs.forEach(input => {
        input.addEventListener('change', function() {
           // Provide a simple way to find the matching variant ID
           // Note: In a full theme, we'd map JSON options to IDs. 
           // For now, we assume the value IS the title, but we need the ID.
           // Since we don't have a massive JSON map here, let's try a simpler approach if possible.
           // Relying on the typical &variant=URL param update or similar.
           
           // For this specific 'Fix', we'll make sure the form SUBMITS the ID.
           // The liquid loop ensures default.
           // We need to fetch the ID for the combination.
        });
     });
     
     // CRITICAL FIX: Ensure the hidden ID input is actually inside the form or linked
     // The form ID is 'product-form-installment'.
     // The input line 145 IS inside the form tags in the liquid file.
     // Is 'product.selected_or_first_available_variant.id' null?
     
     // Only other cause: The Variant Picker Block is OUTSIDE the form.
     // When user clicks a pill, we must update the <input name="id"> value.
  });
  
  // We need to inject the variant map to make this work 100% on client side switch
  // But first, let's fix the basic "Add" if it's failing on default load.
  // The error "Parameter Missing: id" means the input is empty or missing.
  
</script>

{%- # JSON Map for Variants (Crucial for JS selection) -%}
<script type="application/json" id="ProductVariants-{{ section.id }}">
  [
  {%- for variant in product.variants -%}
    {
      "id": {{ variant.id }},
      "title": "{{ variant.title }}",
      "options": {{ variant.options | json }},
      "featured_media": {
        "src": "{{ variant.featured_media | image_url: width: 1200 }}",
        "id": {{ variant.featured_media.id | default: 'null' }}
      }
    }{% unless forloop.last %},{% endunless %}
  {%- endfor -%}
  ]
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      // 1. Get Elements
      const form = document.getElementById('product-form-installment');
      const variantScript = document.getElementById('ProductVariants-{{ section.id }}');
      const fieldsets = document.querySelectorAll('.product-variant-picker fieldset');
      
      // 2. Parse Data
      let variantData = [];
      if(variantScript && variantScript.textContent) {
        try {
           variantData = JSON.parse(variantScript.textContent);
        } catch(e) { console.error('Variant JSON Error', e); }
      }
      
      // 3. Helper: Update Hidden ID in Form
      function updateFormId(id) {
         if(!form || !id) return;
         
         // Try to find existing input
         let input = form.querySelector('input[name="id"]');
         
         // If missing, create it (Safety fallback)
         if(!input) {
             input = document.createElement('input');
             input.type = 'hidden';
             input.name = 'id';
             form.appendChild(input);
         }
         
         input.value = id;
         // console.log('Updated Form ID to:', id);
      }
      
      // 4. Update Function
      function updateVariant() {
          // Get current selection
          const selectedOptions = Array.from(fieldsets).map(fieldset => {
              const checked = fieldset.querySelector('input:checked');
              return checked ? checked.value : null;
          }).filter(Boolean); // Remove nulls
          
          // Debugging
          // console.log('Selected:', selectedOptions);
          
          // Find logic
          const matchedVariant = variantData.find(variant => {
              // Compare arrays. variant.options is array of strings.
              if(variant.options.length !== selectedOptions.length) return false;
              return variant.options.every((opt, i) => opt === selectedOptions[i]);
          });
          
          if(matchedVariant) {
              updateFormId(matchedVariant.id);
              // Update URL history without reload
              window.history.replaceState({}, '', `?variant=${matchedVariant.id}`);
              
              // Switch Image if available
              if(matchedVariant.featured_media && matchedVariant.featured_media.src) {
                 const mainImg = document.getElementById('MainImage-{{ section.id }}');
                 if(mainImg) {
                    mainImg.src = matchedVariant.featured_media.src;
                 }
              }
          }
      }
      
      // 5. Initial Run (Important! Ensure default is set)
      updateVariant(); // Run once on load to ensure input matches default selection
      
      // 6. Listeners
      fieldsets.forEach(fs => {
         fs.addEventListener('change', updateVariant);
      });
      
      // 7. Button Logic (Redirects & AJAX)
      const btnBuyNow = document.getElementById('btn-buy-now');
      const btnAddToCart = document.getElementById('btn-add-to-cart');
      
      // Buy Now: Standard Submit with Checkout Redirect
      if(form && btnBuyNow) {
          btnBuyNow.addEventListener('click', (e) => {
              e.preventDefault(); // Stop normal submit
              
              // 1. Update/Ensure ID
              let currentId = null;
              
              // Try to update from matching variant (visual state)
              updateVariant();
              
              // Check input
              const idInput = form.querySelector('input[name="id"]');
              if(idInput && idInput.value) {
                  currentId = idInput.value;
              } else if (variantData.length > 0) {
                  // Fallback: First Variant
                  currentId = variantData[0].id;
                  updateFormId(currentId);
              }
              
              if(!currentId) {
                  alert('Please select a variant.');
                  return;
              }
              
              // 2. Add return_to
              let input = form.querySelector('input[name="return_to"]');
              if(!input) {
                  input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = 'return_to';
                  form.appendChild(input);
              }
              input.value = '/checkout';
              
              // CRITICAL: Handle Dynamic Discount for "Buy Now" based on Qty
              const bundleContainer = document.querySelector('.bundle-selector');
              const bundleQtyInput = document.getElementById('bundle-qty-hidden');
              if(bundleContainer && bundleQtyInput) {
                  const qty = parseInt(bundleQtyInput.value);
                  let discountCode = '';
                  
                  // Read data attributes
                  const code2 = bundleContainer.getAttribute('data-tier2-code');
                  const code3 = bundleContainer.getAttribute('data-tier3-code');
                  
                  if(qty >= 3 && code3) {
                      discountCode = code3;
                  } else if(qty >= 2 && code2) {
                      discountCode = code2;
                  }
                  
                  // If we have a code, construct checkout URL manually
                  if(discountCode) {
                      // e.g. /cart/ID:QTY?discount=CODE
                      const checkoutUrl = `/cart/${currentId}:${qty}?discount=${discountCode}`;
                      window.location.href = checkoutUrl;
                      return; // Stop form submit logic
                  }
              }

              // 3. Submit
              form.submit();
          });
      }
      
      // Add to Cart: AJAX + Drawer
      if(form && btnAddToCart) {
          btnAddToCart.addEventListener('click', (e) => {
              e.preventDefault(); // Stop normal submit
              
              // Ensure ID is up to date
              updateVariant();
              
              const idInput = form.querySelector('input[name="id"]');
              // FAILSAFE: If no ID set, set to first variant ID
              if((!idInput || !idInput.value) && variantData.length > 0) {
                 updateFormId(variantData[0].id);
              }
              
              // Remove return_to if exists (cleanup)
              const returnInput = form.querySelector('input[name="return_to"]');
              if(returnInput) returnInput.remove();
              
              // Prepare Payload
              const formData = new FormData(form);
              
              // If using bundle selector 'items[0][quantity]', we need to map it to standard 'quantity' for the simple /cart/add.js endpoint
              // Or just construct manually.
              const id = form.querySelector('input[name="id"]').value;
              
              // Check for bundle hidden quantity
              let qty = 1;
              const bundleInput = document.getElementById('bundle-qty-hidden');
              if(bundleInput) qty = parseInt(bundleInput.value);
              
              // Payload
              const payload = {
                  items: [{
                      id: id,
                      quantity: qty
                  }]
              };
              
              // Loading State
              btnAddToCart.textContent = 'Adding...';
              btnAddToCart.disabled = true;
              
              fetch(window.Shopify.routes.root + 'cart/add.js', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(payload)
              })
              .then(response => {
                  return response.json();
              })
              .then(data => {
                  if(data.status && data.status === 422) {
                      throw new Error(data.description || 'Could not add to cart.');
                  }
                  
                  // SUCCESS: Check for Discount Code to Apply (Attribute)
                  const bundleContainer = document.querySelector('.bundle-selector');
                  const bundleQtyInput = document.getElementById('bundle-qty-hidden');
                  let discountCode = '';
                  
                  if(bundleContainer && bundleQtyInput) {
                      const qty = parseInt(bundleQtyInput.value);
                      const code2 = bundleContainer.getAttribute('data-tier2-code');
                      const code3 = bundleContainer.getAttribute('data-tier3-code');
                      
                      if(qty >= 3 && code3) discountCode = code3;
                      else if(qty >= 2 && code2) discountCode = code2;
                  }
                  
                  // If Discount, save to Cart Attributes
                  if(discountCode) {
                      return fetch(window.Shopify.routes.root + 'cart/update.js', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ attributes: { 'discount_code': discountCode } })
                      }).then(() => data); // Return original data
                  }
                  
                  return data;
              })
              .then(data => {
                  btnAddToCart.textContent = 'Add to Cart';
                  btnAddToCart.disabled = false;
                  
                  // Open Drawer
                  if(window.openCartDrawer) {
                      window.openCartDrawer();
                  } else {
                      window.location.href = '/cart';
                  }
              })
              .catch((error) => {
                  console.error('Error:', error);
                  btnAddToCart.textContent = 'Add to Cart';
                  btnAddToCart.disabled = false;
                  alert(error.message || 'An error occurred.');
              });
          });
      }
  });
</script>

<style>
  /* Bundle Selector CSS */
  .bundle-selector { margin: 1rem 0; }
  .bundle-options { display: flex; flex-direction: column; gap: 0.75rem; }
  .bundle-option {
    display: flex; align-items: center;
    border: 2px solid #e0e0e0; border-radius: 8px;
    padding: 10px; cursor: pointer; transition: all 0.2s;
    background: #fff;
  }
  .bundle-option.active { border-color: #000; background-color: #f9f9f9; }
  
  .radio-circle {
    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; margin-right: 1rem; position: relative;
  }
  .bundle-option.active .radio-circle { border-color: #000; }
  .bundle-option.active .radio-circle::after {
    content: ''; position: absolute; top: 3px; left: 3px; width: 8px; height: 8px; background: #000; border-radius: 50%;
  }
  
  .bundle-details { flex: 1; }
  .bundle-title { font-weight: 700; display: block; font-size: 0.9rem; }
  .bundle-price { font-size: 0.85rem; color: #555; }
  .flex-between { display: flex; justify-content: space-between; width: 100%; }
  
  .badge-best-seller { background: #FFA41C; color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

  /* Previous Styles... */
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    background: #fff;
  }
  
  .product-container {
     max-width: 1200px; margin: 0 auto; padding: 0 20px;
  }
  
  @media screen and (max-width: 768px) {
    .product-container {
       padding: 0 16px; /* Slightly tighter on mobile */
    }
  }

  .product-layout {
    /* Layout handled by media queries */
    width: 100%;
  }

  /* Media Gallery */
  .product-media-wrapper { 
    display: flex; flex-direction: column; gap: 1rem; 
    width: 100%; max-width: 550px; margin: 0 auto; /* Constraint width */
  }
  .product-media-main {
    width: 100%;
    position: relative;
    /* Removed fixed aspect-ratio to let image define height naturally */
    background: transparent; 
    border-radius: 12px;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid #f0f0f0; /* Subtle border */
  }
  


  .main-image { width: 100%; height: auto; object-fit: contain; }
  
  .product-thumbnails {
    display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
  }
  .thumbnail-item {
     flex: 0 0 80px; height: 80px; 
     border: 2px solid transparent; border-radius: 8px; 
     cursor: pointer; overflow: hidden; background: #f8f8f8;
     transition: all 0.2s;
  }
  .thumbnail-item.active { border-color: #000; }
  .thumbnail-item img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }

  /* Info Column */
  .product-info-wrapper { display: flex; flex-direction: column; gap: 1.5rem; }
  
  .product-title {
    font-size: 1.8rem; font-weight: 700; line-height: 1.2; margin-bottom: 0.5rem; color: #111;
  }
  
  .product-rating-row { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
  .rating-stars { color: #FFA41C; display: flex; font-size: 1rem; }
  .rating-count { color: #555; text-decoration: underline; }

  /* Price */
  .price-container { display: flex; align-items: baseline; gap: 8px; margin-top: 0.5rem; }
  .price-currency { font-size: 0.9rem; font-weight: 500; }
  .price-current { font-size: 1.8rem; font-weight: 700; color: #B12704; }
  .price-original { text-decoration: line-through; color: #777; font-size: 1rem; }
  .discount-badge { 
     background: #cc0c39; color: #fff; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem;
     position: relative;
  }
  /* Optional: The "Cut line" visual if needed beyond standard strikethrough */

  /* Specifications Box */
  .product-specs-box {
    background: #f9f9f9; padding: 1rem; border-radius: 8px; border: 1px solid #eee;
  }
  .specs-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }
  .specs-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #555; }
  .specs-list li { margin-bottom: 4px; }

  /* Actions */
  .qty-wrapper { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
  .qty-label { font-weight: 600; }
  .qty-stepper {
    display: flex; align-items: center; border: 1px solid #ccc; border-radius: 20px; overflow: hidden;
  }
  .qty-btn { background: #f0f0f0; border: none; width: 32px; height: 32px; cursor: pointer; font-weight: bold; }
  .qty-btn:hover { background: #e0e0e0; }
  .qty-input { width: 40px; text-align: center; border: none; font-weight: 600; outline: none; }

  .action-buttons { display: flex; flex-direction: column; gap: 10px; }
  .btn-atc-pill {
     width: 100%; background: #000; color: #fff; border: none; padding: 12px; 
     border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer;
     transition: opacity 0.2s;
  }
  .btn-atc-pill:hover { opacity: 0.9; }
  
  .btn-buy-now {
     width: 100%; background: #FFA41C; color: #000; border: none; padding: 12px; 
     border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer;
     transition: opacity 0.2s;
  }
  .btn-buy-now:hover { opacity: 0.9; }

  /* Trust Icons */
  .product-trust-row {
    display: flex; gap: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;
  }
  .trust-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8rem; color: #555; text-align: center; }
  .trust-icon { font-size: 1.5rem; }

  /* Variant Picker */
  .product-variant-picker { margin: 1rem 0; }
  .form__label { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.5rem; display: block; }
  .variant-options { display: flex; gap: 8px; flex-wrap: wrap; }
  .variant-pill { position: relative; cursor: pointer; }
  .variant-pill input { position: absolute; opacity: 0; width: 0; height: 0; }
  .variant-pill span {
     padding: 8px 16px; border: 1px solid #ccc; border-radius: 20px; font-size: 0.9rem; display: inline-block; transition: all 0.2s;
  }
  .variant-pill input:checked + span {
     background: #000; color: #fff; border-color: #000;
  }

  /* Color Circle Mode */
  .variant-pill.variant-circle {
     padding: 3px; border-radius: 50%; width: 42px; height: 42px;
     border: 1px solid transparent; 
     display: flex; align-items: center; justify-content: center;
  }
  .variant-pill.variant-circle:has(input:checked) {
     border-color: #000; /* Outer Ring */
  }
  
  .circle-swatch {
     display: block; width: 100%; height: 100%; 
     border-radius: 50%;
     background-color: var(--swatch-color, #ccc);
     border: 1px solid rgba(0,0,0,0.1);
     /* Override standard pill styles */
     padding: 0 !important; margin: 0 !important;
  }
  
  /* Reset default pill checked style for circle */
  .variant-pill.variant-circle input:checked + .circle-swatch {
     background-color: var(--swatch-color); /* Keep original color */
     color: transparent; border-color: rgba(0,0,0,0.1);
  }

  /* Accordion Styles */
  .product-bottom-accordions {
     margin-top: 3rem;
     border-top: 1px solid #e5e5e5; /* Top separator for the whole section */
  }
  .product-accordion {
    border-bottom: 1px solid #e5e5e5;
  }
  
  .accordion-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.5rem 0; /* More spacing for full width */
    cursor: pointer;
    list-style: none; /* Remove default triangle */
  }
  .accordion-header::-webkit-details-marker { display: none; }
  .accordion-title { font-weight: 700; font-size: 1.1rem; color: #000; }
  .accordion-icon { font-size: 1.2rem; font-weight: 300; }
  .product-accordion[open] .accordion-icon { transform: rotate(45deg); display:inline-block; } /* Simple + to x rotation or similar */
  
  .accordion-content { padding-bottom: 1.5rem; color: #555; line-height: 1.6; }
  .specs-list { list-style: none; padding: 0; margin: 0; }
  .specs-list li { margin-bottom: 0.5rem; font-size: 0.9rem; }

  /* Desktop Grid */
  @media screen and (min-width: 900px) {
    .product-layout {
       display: grid;
       grid-template-columns: 1fr 1fr; /* Balanced 50/50 Split */
       gap: 4rem;
       align-items: start;
    }
  }
  
  /* Mobile Layout - Strict Enforcement */
  @media screen and (max-width: 899px) {
     .product-layout {
        display: flex; flex-direction: column; gap: 2rem;
     }
     
     .product-media-wrapper {
        width: 100% !important; max-width: 100% !important; margin: 0 !important;
     }
     
     .product-media-main {
        width: 100% !important; height: auto !important; aspect-ratio: auto !important;
        border: none !important; border-radius: 0 !important;
        background: transparent !important;
     }
     
     .main-image {
        width: 100% !important; height: auto !important; object-fit: contain !important;
        max-height: none !important;
     }
  }
</style>

{% schema %}
{
  "name": "Marketplace Product",
  "settings": [
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "default": 36, "label": "Padding Top" },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "default": 36, "label": "Padding Bottom" }
  ],
  "blocks": [
    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },
    { 
      "type": "variant_picker", 
      "name": "Variant Picker", 
      "limit": 1,
      "settings": [
        {
          "type": "select",
          "id": "color_style",
          "label": "Color Option Style",
          "options": [
            { "value": "text", "label": "Text (Pills)" },
            { "value": "circle", "label": "Color Circles" }
          ],
          "default": "text"
        },
        {
          "type": "checkbox",
          "id": "enable_ships_from",
          "label": "Show 'Ships From' Option",
          "default": true
        }
      ]
    },
    { 
      "type": "bundle_selector", 
      "name": "Bundle Selector", 
      "limit": 1,
      "settings": [
         { "type": "header", "content": "Tier 2 (Buy 2)" },
         { "type": "range", "id": "tier_2_percent", "min": 0, "max": 90, "step": 5, "default": 10, "label": "Discount %" },
         { "type": "text", "id": "tier_2_code", "label": "Discount Code (Optional)", "info": "Code to apply at checkout for 'Buy Now'." },
         
         { "type": "header", "content": "Tier 3 (Buy 3)" },
         { "type": "range", "id": "tier_3_percent", "min": 0, "max": 90, "step": 5, "default": 20, "label": "Discount %" },
         { "type": "text", "id": "tier_3_code", "label": "Discount Code (Optional)", "info": "Code to apply at checkout for 'Buy Now'." }
      ]
    },
    { "type": "buy_buttons", "name": "Buy Actions", "limit": 1 },
    { "type": "trust_icons", "name": "Trust Badges", "limit": 1 },
    { "type": "specifications", "name": "Specifications", "limit": 1 },
    { "type": "description", "name": "Description", "limit": 1 },
    {
      "type": "custom_liquid",
      "name": "Custom Liquid",
      "settings": [
        {
          "type": "liquid",
          "id": "custom_liquid",
          "label": "Custom Liquid",
          "info": "Add app snippets or other Liquid code."
        }
      ]
    }
  ],
  "default": {
     "blocks": [
       {"type": "title"},
       {"type": "price"},
       {"type": "variant_picker"},
       {"type": "bundle_selector"},
       {"type": "buy_buttons"},
       {"type": "trust_icons"},
       {"type": "specifications"},
       {"type": "description"}
     ]
  }
}
{% endschema %}
