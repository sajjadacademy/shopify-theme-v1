<div class="product-section section-{{ section.id }}-padding" id="MainProduct-{{ section.id }}">
  <div class="container">
    <div class="product-layout">
      
      <!-- LEFT: Media Gallery -->
      <div class="product-media-wrapper">
         <div class="product-media-main">
            {%- if product.selected_or_first_available_variant.featured_media != null -%}
              {%- assign featured_media = product.selected_or_first_available_variant.featured_media -%}
            {%- else -%}
              {%- assign featured_media = product.featured_media -%}
            {%- endif -%}
            
            <img src="{{ featured_media | image_url: width: 1200 }}" 
                 alt="{{ featured_media.alt | escape }}" 
                 id="MainImage-{{ section.id }}" 
                 class="main-image"
                 loading="eager" width="1200" height="1200">
         </div>
         
         {%- if product.media.size > 1 -%}
           <div class="product-thumbnails">
              {%- for media in product.media -%}
                <div class="thumbnail-item {% if media.id == featured_media.id %}active{% endif %}"
                     onclick="changeMainImage('{{ media | image_url: width: 1200 }}', this)">
                   <img src="{{ media | image_url: width: 100 }}" alt="{{ media.alt | escape }}" width="100" height="100">
                </div>
              {%- endfor -%}
           </div>
         {%- endif -%}
      </div>

      <!-- RIGHT: Info Column -->
      <div class="product-info-wrapper">
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            
            <!-- Title & Rating -->
            {%- when 'title' -%}
              <div class="product-block-title" {{ block.shopify_attributes }}>
                <h1 class="product-title h2">{{ product.title }}</h1>
                <div class="product-rating-row">
                   <div class="rating-stars">
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_filled' %}
                      {% render 'icon-dynamic', icon: 'star_half' %}
                   </div>
                   <span class="rating-count">4.9 (Verified)</span>
                </div>
              </div>

            <!-- Price -->
            {%- when 'price' -%}
              <div class="product-block-price" {{ block.shopify_attributes }}>
                 <div class="price-container">
                    <span class="price-currency">AED</span>
                    <span class="price-current">{{ product.price | money_without_currency }}</span>
                    
                    {%- assign compare_price = product.compare_at_price -%}
                    {%- assign product_price = product.price -%}
                    
                    {%- if compare_price > product_price -%}
                        <!-- Real Discount -->
                        <span class="price-original">{{ compare_price | money_without_currency }}</span>
                        {%- assign discount = compare_price | minus: product_price | times: 100.0 | divided_by: compare_price | round -%}
                        <span class="discount-badge">{{ discount }}% Off</span>
                    {%- else -%}
                        <!-- Artificial 10% Discount logic -->
                        {%- assign fake_original = product_price | times: 1.1 | round -%}
                        <span class="price-original" style="opacity: 0.5;">{{ fake_original | money_without_currency }}</span>
                        <span class="discount-badge">10% Off</span>
                    {%- endif -%}
                 </div>
              </div>

            <!-- Variant Picker (Color) -->
            {%- when 'variant_picker' -%}
               {%- unless product.has_only_default_variant -%}
                 <div class="product-variant-picker" {{ block.shopify_attributes }}>
                    {%- for option in product.options_with_values -%}
                       <fieldset class="js product-form__input">
                          <legend class="form__label">{{ option.name }}</legend>
                          <div class="variant-options">
                             {%- for value in option.values -%}
                                <label class="variant-pill">
                                   <input type="radio" name="{{ option.name }}" value="{{ value | escape }}" {% if option.selected_value == value %}checked{% endif %} 
                                          onchange="/* logic to update variant id */">
                                   <span>{{ value }}</span>
                                </label>
                             {%- endfor -%}
                          </div>
                       </fieldset>
                    {%- endfor -%}
                 </div>
               {%- endunless -%}

            <!-- Description/Specs now moved to bottom, so we skip here -->
            {%- when 'description' -%}
            {%- when 'specifications' -%}

            <!-- Bundle Selector (Restored) -->
            {%- when 'bundle_selector' -%}
              <div class="bundle-selector" {{ block.shopify_attributes }}>
                 <h3 class="h4" style="font-size: 1rem; margin-bottom: 0.5rem;">Select Quantity</h3>
                 
                 <input type="hidden" name="items[0][quantity]" value="1" form="product-form-installment" id="bundle-qty-hidden">
                 
                 <div class="bundle-options">
                   <label class="bundle-option active" onclick="selectBundle(1, this)">
                     <span class="radio-circle"></span>
                     <div class="bundle-details">
                       <span class="bundle-title">Buy 1</span>
                       <!-- Using the inflated/fake price logic for consistency if desired, or just raw price -->
                       <span class="bundle-price">{{ product.price | money }}/each</span>
                     </div>
                   </label>
                   
                   <label class="bundle-option" onclick="selectBundle(2, this)">
                     <span class="radio-circle"></span>
                     <div class="bundle-details">
                       <div class="flex-between">
                         <span class="bundle-title">Buy 2 & Save 10%</span>
                         <span class="badge-best-seller">Best Seller</span>
                       </div>
                       <span class="bundle-price">{{ product.price | times: 0.9 | money }}/each</span>
                     </div>
                   </label>
                   
                   <label class="bundle-option" onclick="selectBundle(3, this)">
                     <span class="radio-circle"></span>
                     <div class="bundle-details">
                       <span class="bundle-title">Buy 3 & Save 20%</span>
                       <span class="bundle-price">{{ product.price | times: 0.8 | money }}/each</span>
                     </div>
                   </label>
                 </div>
              </div>

            <!-- Buy Actions -->
            {%- when 'buy_buttons' -%}
               <div class="product-block-actions" {{ block.shopify_attributes }}>
                 {% form 'product', product, id: 'product-form-installment', class: 'product-form' %}
                   <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                   <!-- Quantity handled by Bundle Selector via form attribute -->

                   <!-- Buttons -->
                   <div class="action-buttons">
                     <button type="submit" name="add" class="btn-atc-pill" id="btn-add-to-cart">
                       Add to Cart
                     </button>
                     <button type="submit" name="add" class="btn-buy-now" id="btn-buy-now">
                       Buy Now
                     </button>
                   </div>
                 {% endform %}
               </div>

            <!-- Trust Badges -->
            {%- when 'trust_icons' -%}
               <div class="product-trust-row" {{ block.shopify_attributes }}>
                 <div class="trust-item">
                    <span class="trust-icon">üöö</span>
                    <span class="trust-text">Free Shipment</span>
                 </div>
                 <div class="trust-item">
                    <span class="trust-icon">‚Ü©Ô∏è</span>
                    <span class="trust-text">30 Days Return</span>
                 </div>
                 <div class="trust-item">
                    <span class="trust-icon">üõ°Ô∏è</span>
                    <span class="trust-text">24/7 Support</span>
                 </div>
               </div>

          {%- endcase -%}
        {%- endfor -%}
      </div>
    
    </div>

    <!-- BOTTOM: Detailed Information (Full Width) -->
    <div class="product-bottom-accordions">
       {%- for block in section.blocks -%}
          {%- case block.type -%}
             <!-- Description Accordion -->
             {%- when 'description' -%}
               <details class="product-accordion" {{ block.shopify_attributes }}>
                 <summary class="accordion-header">
                    <span class="accordion-title">Product Specifications</span>
                    <span class="accordion-icon">+</span>
                 </summary>
                 <div class="accordion-content rte">
                   {{ product.description }}
                 </div>
               </details>

             <!-- Specs Accordion -->
             {%- when 'specifications' -%}
               <details class="product-accordion" {{ block.shopify_attributes }}>
                  <summary class="accordion-header">
                    <span class="accordion-title">Additional Information</span>
                    <span class="accordion-icon">+</span>
                  </summary>
                  <div class="accordion-content">
                    <ul class="specs-list">
                      <li><strong>Product Name:</strong> {{ product.title }}</li>
                      <li><strong>SKU:</strong> {{ product.selected_or_first_available_variant.sku | default: 'N/A' }}</li>
                      <li><strong>Stock:</strong> {% if product.available %}In Stock{% else %}Out of Stock{% endif %}</li>
                    </ul>
                  </div>
               </details>
          {%- endcase -%}
       {%- endfor -%}
    </div>
  </div>
</div>

<script>
  function changeMainImage(src, el) {
    document.getElementById('MainImage-{{ section.id }}').src = src;
    document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  }

  function selectBundle(qty, element) {
    /* Visual */
    document.querySelectorAll('.bundle-option').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    /* Logic: Update hidden input linked to form */
    const input = document.getElementById('bundle-qty-hidden');
    if(input) input.value = qty;
  }
  
  /* Variant Selection Handler (Simple) */
  document.addEventListener('DOMContentLoaded', function() {
     const variantInputs = document.querySelectorAll('.product-variant-picker input[type="radio"]');
     variantInputs.forEach(input => {
        input.addEventListener('change', function() {
           // Provide a simple way to find the matching variant ID
           // Note: In a full theme, we'd map JSON options to IDs. 
           // For now, we assume the value IS the title, but we need the ID.
           // Since we don't have a massive JSON map here, let's try a simpler approach if possible.
           // Relying on the typical &variant=URL param update or similar.
           
           // For this specific 'Fix', we'll make sure the form SUBMITS the ID.
           // The liquid loop ensures default.
           // We need to fetch the ID for the combination.
        });
     });
     
     // CRITICAL FIX: Ensure the hidden ID input is actually inside the form or linked
     // The form ID is 'product-form-installment'.
     // The input line 145 IS inside the form tags in the liquid file.
     // Is 'product.selected_or_first_available_variant.id' null?
     
     // Only other cause: The Variant Picker Block is OUTSIDE the form.
     // When user clicks a pill, we must update the <input name="id"> value.
  });
  
  // We need to inject the variant map to make this work 100% on client side switch
  // But first, let's fix the basic "Add" if it's failing on default load.
  // The error "Parameter Missing: id" means the input is empty or missing.
  
</script>

{%- # JSON Map for Variants (Crucial for JS selection) -%}
<script type="application/json" id="ProductVariants-{{ section.id }}">
  [
  {%- for variant in product.variants -%}
    {
      "id": {{ variant.id }},
      "title": "{{ variant.title }}",
      "options": {{ variant.options | json }}
    }{% unless forloop.last %},{% endunless %}
  {%- endfor -%}
  ]
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      // 1. Get Elements
      const form = document.getElementById('product-form-installment');
      const variantScript = document.getElementById('ProductVariants-{{ section.id }}');
      const fieldsets = document.querySelectorAll('.product-variant-picker fieldset');
      
      // 2. Parse Data
      let variantData = [];
      if(variantScript && variantScript.textContent) {
        try {
           variantData = JSON.parse(variantScript.textContent);
        } catch(e) { console.error('Variant JSON Error', e); }
      }
      
      // 3. Helper: Update Hidden ID in Form
      function updateFormId(id) {
         if(!form || !id) return;
         
         // Try to find existing input
         let input = form.querySelector('input[name="id"]');
         
         // If missing, create it (Safety fallback)
         if(!input) {
             input = document.createElement('input');
             input.type = 'hidden';
             input.name = 'id';
             form.appendChild(input);
         }
         
         input.value = id;
         // console.log('Updated Form ID to:', id);
      }
      
      // 4. Update Function
      function updateVariant() {
          // Get current selection
          const selectedOptions = Array.from(fieldsets).map(fieldset => {
              const checked = fieldset.querySelector('input:checked');
              return checked ? checked.value : null;
          }).filter(Boolean); // Remove nulls
          
          // Debugging
          // console.log('Selected:', selectedOptions);
          
          // Find logic
          const matchedVariant = variantData.find(variant => {
              // Compare arrays. variant.options is array of strings.
              if(variant.options.length !== selectedOptions.length) return false;
              return variant.options.every((opt, i) => opt === selectedOptions[i]);
          });
          
          if(matchedVariant) {
              updateFormId(matchedVariant.id);
              // Update URL history without reload
              window.history.replaceState({}, '', `?variant=${matchedVariant.id}`);
          }
      }
      
      // 5. Initial Run (Important! Ensure default is set)
      updateVariant(); // Run once on load to ensure input matches default selection
      
      // 6. Listeners
      fieldsets.forEach(fs => {
         fs.addEventListener('change', updateVariant);
      });
      
      // 7. Button Logic (Redirects & AJAX)
      const btnBuyNow = document.getElementById('btn-buy-now');
      const btnAddToCart = document.getElementById('btn-add-to-cart');
      
      // Buy Now: Standard Submit with Checkout Redirect
      if(form && btnBuyNow) {
          btnBuyNow.addEventListener('click', (e) => {
              // Ensure ID is up to date just in case
              updateVariant();
              
              // Add return_to
              let input = form.querySelector('input[name="return_to"]');
              if(!input) {
                  input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = 'return_to';
                  form.appendChild(input);
              }
              input.value = '/checkout';
              // Form submits naturally
          });
      }
      
      // Add to Cart: AJAX + Drawer
      if(form && btnAddToCart) {
          btnAddToCart.addEventListener('click', (e) => {
              e.preventDefault(); // Stop normal submit
              
              // Ensure ID is up to date
              updateVariant();
              
              // Remove return_to if exists (cleanup)
              const returnInput = form.querySelector('input[name="return_to"]');
              if(returnInput) returnInput.remove();
              
              // Prepare Payload
              const formData = new FormData(form);
              
              // If using bundle selector 'items[0][quantity]', we need to map it to standard 'quantity' for the simple /cart/add.js endpoint
              // Or just construct manually.
              const id = form.querySelector('input[name="id"]').value;
              
              // Check for bundle hidden quantity
              let qty = 1;
              const bundleInput = document.getElementById('bundle-qty-hidden');
              if(bundleInput) qty = parseInt(bundleInput.value);
              
              // Payload
              const payload = {
                  items: [{
                      id: id,
                      quantity: qty
                  }]
              };
              
              // Loading State
              btnAddToCart.textContent = 'Adding...';
              btnAddToCart.disabled = true;
              
              fetch(window.Shopify.routes.root + 'cart/add.js', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(payload)
              })
              .then(response => {
                  return response.json();
              })
              .then(data => {
                  btnAddToCart.textContent = 'Add to Cart';
                  btnAddToCart.disabled = false;
                  
                  if(data.status && data.status === 422) {
                      // Error (e.g. OOS)
                      alert(data.description || 'Could not add to cart.');
                  } else {
                      // Success: Open Drawer
                      if(window.openCartDrawer) {
                          window.openCartDrawer();
                      } else {
                          // Fallback if drawer fails
                          window.location.href = '/cart';
                      }
                  }
              })
              .catch((error) => {
                  console.error('Error:', error);
                  btnAddToCart.textContent = 'Add to Cart';
                  btnAddToCart.disabled = false;
                  alert('An error occurred.');
              });
          });
      }
  });
</script>

<style>
  /* Bundle Selector CSS */
  .bundle-selector { margin: 1rem 0; }
  .bundle-options { display: flex; flex-direction: column; gap: 0.75rem; }
  .bundle-option {
    display: flex; align-items: center;
    border: 2px solid #e0e0e0; border-radius: 8px;
    padding: 10px; cursor: pointer; transition: all 0.2s;
    background: #fff;
  }
  .bundle-option.active { border-color: #000; background-color: #f9f9f9; }
  
  .radio-circle {
    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; margin-right: 1rem; position: relative;
  }
  .bundle-option.active .radio-circle { border-color: #000; }
  .bundle-option.active .radio-circle::after {
    content: ''; position: absolute; top: 3px; left: 3px; width: 8px; height: 8px; background: #000; border-radius: 50%;
  }
  
  .bundle-details { flex: 1; }
  .bundle-title { font-weight: 700; display: block; font-size: 0.9rem; }
  .bundle-price { font-size: 0.85rem; color: #555; }
  .flex-between { display: flex; justify-content: space-between; width: 100%; }
  
  .badge-best-seller { background: #FFA41C; color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

  /* Previous Styles... */
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    background: #fff;
  }

  .product-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 3rem;
  }

  /* Media Gallery */
  .product-media-wrapper { display: flex; flex-direction: column; gap: 1rem; }
  .product-media-main {
    width: 100%;
    aspect-ratio: 1;
    background: #f8f8f8;
    border-radius: 12px;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }
  .main-image { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
  
  .product-thumbnails {
    display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
  }
  .thumbnail-item {
     flex: 0 0 80px; height: 80px; 
     border: 2px solid transparent; border-radius: 8px; 
     cursor: pointer; overflow: hidden; background: #f8f8f8;
     transition: all 0.2s;
  }
  .thumbnail-item.active { border-color: #000; }
  .thumbnail-item img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }

  /* Info Column */
  .product-info-wrapper { display: flex; flex-direction: column; gap: 1.5rem; }
  
  .product-title {
    font-size: 1.8rem; font-weight: 700; line-height: 1.2; margin-bottom: 0.5rem; color: #111;
  }
  
  .product-rating-row { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
  .rating-stars { color: #FFA41C; display: flex; font-size: 1rem; }
  .rating-count { color: #555; text-decoration: underline; }

  /* Price */
  .price-container { display: flex; align-items: baseline; gap: 8px; margin-top: 0.5rem; }
  .price-currency { font-size: 0.9rem; font-weight: 500; }
  .price-current { font-size: 1.8rem; font-weight: 700; color: #B12704; }
  .price-original { text-decoration: line-through; color: #777; font-size: 1rem; }
  .discount-badge { 
     background: #cc0c39; color: #fff; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem;
     position: relative;
  }
  /* Optional: The "Cut line" visual if needed beyond standard strikethrough */

  /* Specifications Box */
  .product-specs-box {
    background: #f9f9f9; padding: 1rem; border-radius: 8px; border: 1px solid #eee;
  }
  .specs-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }
  .specs-list { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #555; }
  .specs-list li { margin-bottom: 4px; }

  /* Actions */
  .qty-wrapper { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
  .qty-label { font-weight: 600; }
  .qty-stepper {
    display: flex; align-items: center; border: 1px solid #ccc; border-radius: 20px; overflow: hidden;
  }
  .qty-btn { background: #f0f0f0; border: none; width: 32px; height: 32px; cursor: pointer; font-weight: bold; }
  .qty-btn:hover { background: #e0e0e0; }
  .qty-input { width: 40px; text-align: center; border: none; font-weight: 600; outline: none; }

  .action-buttons { display: flex; flex-direction: column; gap: 10px; }
  .btn-atc-pill {
     width: 100%; background: #000; color: #fff; border: none; padding: 12px; 
     border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer;
     transition: opacity 0.2s;
  }
  .btn-atc-pill:hover { opacity: 0.9; }
  
  .btn-buy-now {
     width: 100%; background: #FFA41C; color: #000; border: none; padding: 12px; 
     border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer;
     transition: opacity 0.2s;
  }
  .btn-buy-now:hover { opacity: 0.9; }

  /* Trust Icons */
  .product-trust-row {
    display: flex; gap: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee;
  }
  .trust-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8rem; color: #555; text-align: center; }
  .trust-icon { font-size: 1.5rem; }

  /* Variant Picker */
  .product-variant-picker { margin: 1rem 0; }
  .form__label { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.5rem; display: block; }
  .variant-options { display: flex; gap: 8px; flex-wrap: wrap; }
  .variant-pill { position: relative; cursor: pointer; }
  .variant-pill input { position: absolute; opacity: 0; width: 0; height: 0; }
  .variant-pill span {
     padding: 8px 16px; border: 1px solid #ccc; border-radius: 20px; font-size: 0.9rem; display: inline-block; transition: all 0.2s;
  }
  .variant-pill input:checked + span {
     background: #000; color: #fff; border-color: #000;
  }

  /* Accordion Styles */
  .product-bottom-accordions {
     margin-top: 3rem;
     border-top: 1px solid #e5e5e5; /* Top separator for the whole section */
  }
  .product-accordion {
    border-bottom: 1px solid #e5e5e5;
  }
  
  .accordion-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.5rem 0; /* More spacing for full width */
    cursor: pointer;
    list-style: none; /* Remove default triangle */
  }
  .accordion-header::-webkit-details-marker { display: none; }
  .accordion-title { font-weight: 700; font-size: 1.1rem; color: #000; }
  .accordion-icon { font-size: 1.2rem; font-weight: 300; }
  .product-accordion[open] .accordion-icon { transform: rotate(45deg); display:inline-block; } /* Simple + to x rotation or similar */
  
  .accordion-content { padding-bottom: 1.5rem; color: #555; line-height: 1.6; }
  .specs-list { list-style: none; padding: 0; margin: 0; }
  .specs-list li { margin-bottom: 0.5rem; font-size: 0.9rem; }

  /* Desktop Grid */
  @media screen and (min-width: 900px) {
    .product-layout {
       grid-template-columns: 1.4fr 0.8fr; /* Image Left (Larger), Info Right (Smaller) */
       gap: 5rem; /* Increased Gap */
    }
  }
</style>

{% schema %}
{
  "name": "Marketplace Product",
  "settings": [
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "default": 36, "label": "Padding Top" },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "default": 36, "label": "Padding Bottom" }
  ],
  "blocks": [
    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },
    { "type": "variant_picker", "name": "Variant Picker", "limit": 1 },
    { "type": "bundle_selector", "name": "Bundle Selector", "limit": 1 },
    { "type": "buy_buttons", "name": "Buy Actions", "limit": 1 },
    { "type": "trust_icons", "name": "Trust Badges", "limit": 1 },
    { "type": "specifications", "name": "Specifications", "limit": 1 },
    { "type": "description", "name": "Description", "limit": 1 }
  ],
  "default": {
     "blocks": [
       {"type": "title"},
       {"type": "price"},
       {"type": "variant_picker"},
       {"type": "bundle_selector"},
       {"type": "buy_buttons"},
       {"type": "trust_icons"},
       {"type": "specifications"},
       {"type": "description"}
     ]
  }
}
{% endschema %}
