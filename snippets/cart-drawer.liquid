
<!-- CART DRAWER HTML -->
<div id="cart-drawer" class="cart-drawer">
  <div class="cart-drawer-overlay" onclick="closeCartDrawer()"></div>
  <div class="cart-drawer-content">
    
    <div class="drawer-header">
      <h3>Shopping Cart</h3>
      <button class="drawer-close" onclick="closeCartDrawer()">&times;</button>
    </div>

    <div id="drawer-items" class="drawer-body">
      <!-- Items injected via JS -->
      <div class="drawer-loading">Loading...</div>
    </div>

    <div class="drawer-footer">
      <div class="drawer-subtotal">
        <span>Subtotal</span>
        <span id="drawer-total-price">AED 0.00</span>
      </div>
      <a href="/checkout" class="btn-drawer-checkout">Checkout</a>
      <a href="/cart" class="btn-drawer-cart">View Cart</a>
    </div>

  </div>
</div>

<style>
  /* Drawer Styles */
  .cart-drawer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9999; visibility: hidden; opacity: 0; transition: all 0.3s ease;
  }
  .cart-drawer.open { visibility: visible; opacity: 1; }
  
  .cart-drawer-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
  }
  
  .cart-drawer-content {
    position: absolute; top: 0; right: -400px; width: 400px; max-width: 90%; height: 100%;
    background: #fff; display: flex; flex-direction: column;
    transition: right 0.3s ease;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
  }
  .cart-drawer.open .cart-drawer-content { right: 0; }
  
  .drawer-header {
    padding: 1.5rem; border-bottom: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
  }
  .drawer-header h3 { margin: 0; font-size: 1.25rem; }
  .drawer-close { background: none; border: none; font-size: 2rem; cursor: pointer; line-height: 1; }
  
  .drawer-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
  
  .drawer-footer {
    padding: 1.5rem; border-top: 1px solid #eee; background: #f9f9f9;
  }
  .drawer-subtotal { display: flex; justify-content: space-between; margin-bottom: 1rem; font-weight: bold; font-size: 1.1rem; }
  
  .btn-drawer-checkout {
    display: block; width: 100%; background: #000; color: #fff; text-align: center;
    padding: 1rem; border-radius: 50px; text-decoration: none; font-weight: 600; margin-bottom: 0.5rem;
  }
  .btn-drawer-cart {
    display: block; width: 100%; background: #fff; color: #000; text-align: center;
    padding: 1rem; border-radius: 50px; text-decoration: none; font-weight: 600; border: 1px solid #ccc;
  }
  
  /* Item Styles */
  .drawer-item { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
  .drawer-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
  .drawer-item-info { flex: 1; }
  .drawer-item-title { font-weight: 600; font-size: 0.95rem; display: block; margin-bottom: 0.25rem; color:#000; text-decoration:none;}
  .drawer-item-variant { font-size: 0.85rem; color: #777; margin-bottom: 0.5rem; }
  .drawer-item-price { font-weight: 600; }
  
</style>

<script>
  window.cartCurrency = '{{ cart.currency.symbol }}' || 'AED'; // Fallback
  
  function formatMoney(cents) {
    return window.cartCurrency + ' ' + (cents / 100).toFixed(2);
  }

  function openCartDrawer() {
    document.getElementById('cart-drawer').classList.add('open');
    updateCartDrawer(); // Fetch latest always on open
  }
  
  function closeCartDrawer() {
    document.getElementById('cart-drawer').classList.remove('open');
  }

  function updateCartDrawer() {
     const body = document.getElementById('drawer-items');
     
     fetch('/cart.js')
       .then(res => res.json())
       .then(cart => {
          try {
             // 1. Update Header w/ Total Count
             const bubble = document.querySelector('.cart-count.bubble');
             if(bubble) bubble.textContent = cart.item_count;
             
             // 2. Logic: Analyze Cart for "Same Product" Quantities
             // Rule: If ANY item has Qty >= 3 -> Eligible for Tier 3 (20%)
             // Else If ANY item has Qty >= 2 -> Eligible for Tier 2 (10%)
             let maxItemQty = 0;
             let potentialSavings = 0;
             let appliedTier = 0; // 0, 2, or 3
             
             cart.items.forEach(item => {
                 if(item.quantity > maxItemQty) maxItemQty = item.quantity;
             });
             
             if(maxItemQty >= 3) appliedTier = 3;
             else if(maxItemQty >= 2) appliedTier = 2;
             
             // Determine Code
             let discountCode = '';
             let discountText = '';
             let tierRate = 0;
             
             if(appliedTier === 3) {
                 discountCode = 'BUY3SAVE20';
                 discountText = 'Buy 3 & Save 20%';
                 tierRate = 0.20;
             } else if (appliedTier === 2) {
                 discountCode = 'BUY2SAVE10';
                 discountText = 'Buy 2 & Save 10%';
                 tierRate = 0.10;
             }
             
             // 3. Render Items & Calculate Visual Savings
             let html = '';
             
             cart.items.forEach(item => {
                // Per-Item Discount Logic (Visual Only)
                // If this specific item meets requirements, show discount
                let itemRate = 0;
                if(item.quantity >= 3) itemRate = 0.20;
                else if(item.quantity >= 2) itemRate = 0.10;
                
                // Calculate Price
                let finalLinePrice = item.line_price;
                let originalLinePrice = item.line_price;
                
                // Apply visual discount if this line qualifies
                if(itemRate > 0) {
                    let deduction = originalLinePrice * itemRate;
                    potentialSavings += deduction;
                    finalLinePrice = originalLinePrice - deduction;
                }
                
                const originalPriceFmt = formatMoney(item.original_price);
                const finalPriceFmt = (itemRate > 0) 
                     ? formatMoney(item.original_price * (1 - itemRate)) 
                     : originalPriceFmt;

                html += `
                   <div class="drawer-item">
                      <img src="${item.featured_image.url}" alt="${item.title}">
                      <div class="drawer-item-info">
                         <a href="${item.url}" class="drawer-item-title">${item.product_title}</a>
                         ${item.variant_title ? `<div class="drawer-item-variant">${item.variant_title}</div>` : ''}
                         
                         <div class="drawer-item-price-row">
                             ${itemRate > 0 
                               ? `<span style="text-decoration:line-through; color:#999; font-size:0.85rem; margin-right:6px;">${originalPriceFmt}</span> <span style="font-weight:700; color:#b12704;">${finalPriceFmt}</span>` 
                               : `<span style="font-weight:600;">${originalPriceFmt}</span>`
                             }
                         </div>
                         
                         <div class="drawer-item-qty" style="font-size:0.8rem; color:#555; margin-top:4px;">
                             Qty: ${item.quantity} 
                             ${itemRate > 0 ? `<span style="color:green; font-weight:bold; margin-left:6px;">(${itemRate * 100}% Off)</span>` : ''}
                         </div>
                      </div>
                   </div>
                `;
             });
             
             if(cart.item_count === 0) {
                body.innerHTML = '<p class="text-center" style="padding:2rem;">Your cart is empty.</p>';
             } else {
                body.innerHTML = html;
             }
             
             // 4. Update Footer Totals
             const totalEl = document.getElementById('drawer-total-price');
             if(totalEl) {
                 if(potentialSavings > 0) {
                     // Show Subtotal with Strike
                     // Note: subtotal is cart.total_price (which might be pre-discount if code not yet applied, or post. 
                     // Since we auto-apply via URL, cart.total_price usually reflects raw unless scripts run.
                     // We visualy calculate 'Estimated Total'
                     
                     let rawTotal = cart.total_price;
                     let estTotal = rawTotal - potentialSavings;
                     
                     // Show Discount Line
                     let discountLine = document.getElementById('drawer-discount-line');
                     if(!discountLine) {
                         discountLine = document.createElement('div');
                         discountLine.id = 'drawer-discount-line';
                         discountLine.className = 'drawer-subtotal';
                         discountLine.style.color = 'green';
                         totalEl.parentElement.before(discountLine);
                     }
                     discountLine.innerHTML = `<span>Savings</span><span>- ${formatMoney(potentialSavings)}</span>`;
                     
                     // Update Total Display
                     totalEl.innerHTML = `<span style="text-decoration:line-through; color:#999; margin-right:5px;">${formatMoney(rawTotal)}</span> ${formatMoney(estTotal)}`;
                 } else {
                     // Reset
                     const dLine = document.getElementById('drawer-discount-line');
                     if(dLine) dLine.remove();
                     totalEl.textContent = formatMoney(cart.total_price);
                 }
             }

             // 5. Checkout Button & Auto-Apply
             const checkoutBtn = document.querySelector('.btn-drawer-checkout');
             if(checkoutBtn) {
                if(discountCode) {
                    checkoutBtn.href = `/checkout?discount=${discountCode}`;
                    
                    // Banner
                    let msg = document.getElementById('drawer-discount-msg');
                    if(!msg) {
                         msg = document.createElement('div');
                         msg.id = 'drawer-discount-msg';
                         msg.style.cssText = 'color: #fff; background: #000; font-size: 0.85rem; text-align: center; padding: 6px; border-radius: 4px; margin-bottom: 8px;';
                         checkoutBtn.before(msg);
                    }
                    msg.innerText = `Offer Unlocked: ${discountText}`;
                } else {
                    checkoutBtn.href = '/checkout';
                    const msg = document.getElementById('drawer-discount-msg');
                    if(msg) msg.remove();
                }
             }

          } catch(e) {
             console.error('Drawer Error:', e);
             body.innerHTML = '<p class="text-center" style="color:red">Error loading cart.</p>';
          }
       })
       .catch(err => console.error(err));
  }
</script>
