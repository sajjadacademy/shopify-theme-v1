
<!-- CART DRAWER HTML -->
<div id="cart-drawer" class="cart-drawer">
  <div class="cart-drawer-overlay" onclick="closeCartDrawer()"></div>
  <div class="cart-drawer-content">
    
    <div class="drawer-header">
      <h3>Shopping Cart</h3>
      <button class="drawer-close" onclick="closeCartDrawer()">&times;</button>
    </div>

    <div id="drawer-items" class="drawer-body">
      <!-- Items injected via JS -->
      <div class="drawer-loading">Loading...</div>
    </div>

    <div class="drawer-footer">
      <div class="drawer-subtotal">
        <span>Subtotal</span>
        <span id="drawer-total-price">AED 0.00</span>
      </div>
      <a href="/checkout" class="btn-drawer-checkout">Checkout</a>
      <a href="/cart" class="btn-drawer-cart">View Cart</a>
    </div>

  </div>
</div>

<style>
  /* Drawer Styles */
  .cart-drawer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9999; visibility: hidden; opacity: 0; transition: all 0.3s ease;
  }
  .cart-drawer.open { visibility: visible; opacity: 1; }
  
  .cart-drawer-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
  }
  
  .cart-drawer-content {
    position: absolute; top: 0; right: -400px; width: 400px; max-width: 90%; height: 100%;
    background: #fff; display: flex; flex-direction: column;
    transition: right 0.3s ease;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
  }
  .cart-drawer.open .cart-drawer-content { right: 0; }
  
  .drawer-header {
    padding: 1.5rem; border-bottom: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
  }
  .drawer-header h3 { margin: 0; font-size: 1.25rem; }
  .drawer-close { background: none; border: none; font-size: 2rem; cursor: pointer; line-height: 1; }
  
  .drawer-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
  
  .drawer-footer {
    padding: 1.5rem; border-top: 1px solid #eee; background: #f9f9f9;
  }
  .drawer-subtotal { display: flex; justify-content: space-between; margin-bottom: 1rem; font-weight: bold; font-size: 1.1rem; }
  
  .btn-drawer-checkout {
    display: block; width: 100%; background: #000; color: #fff; text-align: center;
    padding: 1rem; border-radius: 50px; text-decoration: none; font-weight: 600; margin-bottom: 0.5rem;
  }
  .btn-drawer-cart {
    display: block; width: 100%; background: #fff; color: #000; text-align: center;
    padding: 1rem; border-radius: 50px; text-decoration: none; font-weight: 600; border: 1px solid #ccc;
  }
  
  /* Item Styles */
  .drawer-item { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
  .drawer-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
  .drawer-item-info { flex: 1; }
  .drawer-item-title { font-weight: 600; font-size: 0.95rem; display: block; margin-bottom: 0.25rem; color:#000; text-decoration:none;}
  .drawer-item-variant { font-size: 0.85rem; color: #777; margin-bottom: 0.5rem; }
  .drawer-item-price { font-weight: 600; }
  
</style>

<script>
  window.cartCurrency = '{{ cart.currency.symbol }}' || 'AED'; // Fallback
  
  function formatMoney(cents) {
    return window.cartCurrency + ' ' + (cents / 100).toFixed(2);
  }

  function openCartDrawer() {
    document.getElementById('cart-drawer').classList.add('open');
    updateCartDrawer(); // Fetch latest always on open
  }
  
  function closeCartDrawer() {
    document.getElementById('cart-drawer').classList.remove('open');
  }

  function updateCartDrawer() {
     const body = document.getElementById('drawer-items');
     // body.innerHTML = '<div class="drawer-loading">Loading...</div>';
     
     fetch('/cart.js')
       .then(res => res.json())
       .then(cart => {
          try {
             // Update Count in Header (if exists)
             const bubble = document.querySelector('.cart-count.bubble');
             if(bubble) bubble.textContent = cart.item_count;
             
             // CHECKOUT DISCOUNT (Inject)
             const checkoutBtn = document.querySelector('.btn-drawer-checkout');
             if(checkoutBtn) {
                if(cart.attributes && cart.attributes.discount_code) {
                    checkoutBtn.href = `/checkout?discount=${cart.attributes.discount_code}`;
                    // Indicator
                    let msg = document.getElementById('drawer-discount-msg');
                    if(!msg) {
                        msg = document.createElement('div');
                        msg.id = 'drawer-discount-msg';
                        msg.style.color = 'green';
                        msg.style.fontSize = '0.9rem';
                        msg.style.textAlign = 'center';
                        msg.style.marginBottom = '0.5rem';
                        checkoutBtn.before(msg);
                    }
                    msg.innerText = `Discount Code '${cart.attributes.discount_code}' applied!`;
                } else {
                    checkoutBtn.href = '/checkout';
                    const msg = document.getElementById('drawer-discount-msg');
                    if(msg) msg.remove();
                }
             }
             
             // Update Total
             const totalEl = document.getElementById('drawer-total-price');
             if(totalEl) totalEl.textContent = formatMoney(cart.total_price);
             
             if(cart.item_count === 0) {
                body.innerHTML = '<p class="text-center">Your cart is empty.</p>';
                return;
             }
             
             // Render Items & Calculate Discounts
             let html = '';
             let eligibleQty = 0;
             let subtotal = cart.total_price;
             
             cart.items.forEach(item => {
                // Check property (Robust)
                let isEligible = false;
                if(item.properties) {
                    // Convert to array of keys to find match ignoring some specifics
                    const props = item.properties;
                    if(props['_qty_offer_eligible'] || props['qty_offer'] || props['_offer_eligible']) {
                        isEligible = true;
                    }
                }
                
                if(isEligible) {
                    eligibleQty += item.quantity;
                }
                
                html += `
                   <div class="drawer-item">
                      <img src="${item.featured_image.url}" alt="${item.title}">
                      <div class="drawer-item-info">
                         <a href="${item.url}" class="drawer-item-title">${item.product_title}</a>
                         ${item.variant_title ? `<div class="drawer-item-variant">${item.variant_title}</div>` : ''}
                         <div class="drawer-item-price">${formatMoney(item.line_price)}</div>
                         <div class="drawer-item-qty" style="font-size:0.8rem; color:#666;">Qty: ${item.quantity}</div>
                      </div>
                   </div>
                `;
             });
             
             body.innerHTML = html;
             
             // DISCOUNT LOGIC (The "Brain")
             let discountCode = '';
             let savings = 0;
             let discountText = '';
             
             // Rule: Buy 3 -> 20%, Buy 2 -> 10%
             if(eligibleQty >= 3) {
                 discountCode = 'BUY3SAVE20';
                 discountText = 'Buy 3 & Save 20%';
                 savings = subtotal * 0.20; // Estimated
             } else if (eligibleQty >= 2) {
                 discountCode = 'BUY2SAVE10';
                 discountText = 'Buy 2 & Save 10%';
                 savings = subtotal * 0.10; // Estimated
             }
             
             // UI Updates
             if(totalEl) {
                 // Inject Discount Line if Savings exist
                 let discountLine = document.getElementById('drawer-discount-line');
                 if(savings > 0) {
                     if(!discountLine) {
                        discountLine = document.createElement('div');
                        discountLine.id = 'drawer-discount-line';
                        discountLine.className = 'drawer-subtotal';
                        discountLine.style.color = 'green';
                        totalEl.parentElement.before(discountLine);
                     }
                     discountLine.innerHTML = `<span>${discountText}</span><span>- ${formatMoney(savings)}</span>`;
                     
                     // Update Final Total visual
                     totalEl.innerHTML = `<span style="text-decoration:line-through; color:#999; margin-right:5px;">${formatMoney(subtotal)}</span> ${formatMoney(subtotal - savings)}`;
                 } else {
                     if(discountLine) discountLine.remove();
                     totalEl.textContent = formatMoney(subtotal);
                 }
             }
             
             // Re-apply Checkout Button Logic specifically for computed discount
             if(checkoutBtn && discountCode) {
                 checkoutBtn.href = `/checkout?discount=${discountCode}`;
             }
          } catch(e) {
             console.error('Drawer Error:', e);
             body.innerHTML = '<p class="text-center" style="color:red">Error loading cart.</p>';
          }
       })
       .catch(err => console.error(err));
  }
</script>
