{% comment %}
  Renders a product card with marketplace styling.
  Accepts:
  - product: {Object} Product Liquid object.
  - show_rating: {Boolean} Show rating star and count.
  - show_badge: {Boolean} Show best seller/custom badges.
  - show_wishlist: {Boolean} Show wishlist heart button.
  - show_quick_add: {Boolean} Show quick add button.
  - quick_add_type: {String} 'icon' (plus) or 'button' (full text).
  - quick_add_type: {String} 'icon' (plus) or 'button' (full text).
  - enable_fake_discount: {Boolean} Enable artificial discount if no compare price.
  - fake_discount_percentage: {Number} Percentage to inflate price by.
  - force_tag_discount: {Boolean} Check for 'discount_X' tags.
{% endcomment %}

<div class="product-card-marketplace">
  <!-- PHASE 1: Image Area -->
  <div class="pcm-image-wrapper">
    <a href="{{ product.url }}" class="pcm-link">
      {%- if product.featured_image != blank -%}
        <img
          src="{{ product.featured_image | image_url: width: 400 }}"
          alt="{{ product.title | escape }}"
          loading="lazy"
          width="200"
          height="200"
          class="pcm-image"
        >
      {%- else -%}
        {{ 'product-1' | placeholder_svg_tag: 'pcm-image placeholder-svg' }}
      {%- endif -%}
    </a>
    
    {%- if show_wishlist -%}
      <button class="pcm-wishlist-btn" 
              aria-label="Add to Wishlist"
              data-product-handle="{{ product.handle }}"
              data-product-id="{{ product.selected_or_first_available_variant.id }}"
              onclick="toggleWishlist(this, '{{ product.handle }}', '{{ product.selected_or_first_available_variant.id }}', '{{ product.title | escape }}', '{{ product.featured_image | image_url: width: 200 }}', '{{ product.price | money_without_currency }}')">
        {% render 'icon-dynamic', icon: 'heart' %}
      </button>
      
      <script>
      // Helper specific to cards to avoid multiple definitions if not careful, 
      // but ideally this function is global. We will define it safely.
      if(typeof toggleWishlist === 'undefined') {
          window.toggleWishlist = function(btn, handle, id, title, image, price) {
              const wishlistKey = 'shopify-wishlist';
              let items = JSON.parse(localStorage.getItem(wishlistKey) || '[]');
              
              const existingIndex = items.findIndex(item => item.handle === handle);
              
              if(existingIndex > -1) {
                  // Remove
                  items.splice(existingIndex, 1);
                  btn.classList.remove('active');
                  btn.querySelector('svg').style.fill = 'none';
              } else {
                  // Add
                  items.push({ handle, id, title, image, price });
                  btn.classList.add('active');
                  btn.querySelector('svg').style.fill = 'currentColor';
              }
              
              localStorage.setItem(wishlistKey, JSON.stringify(items));
              window.dispatchEvent(new Event('wishlist-updated'));
          }
      }
      
      // Auto-check state on load
      document.addEventListener('DOMContentLoaded', function() {
           const wishlistKey = 'shopify-wishlist';
           const items = JSON.parse(localStorage.getItem(wishlistKey) || '[]');
           const btn = document.querySelector(`button[data-product-handle='{{ product.handle }}']`);
           if(items.some(i => i.handle === '{{ product.handle }}') && btn) {
               btn.classList.add('active');
               btn.querySelector('svg').style.fill = 'currentColor';
           }
      });
      </script>
    {%- endif -%}

    {%- if show_badge -%}
       {%- if product.tags contains 'Best Seller' -%}
          <span class="pcm-badge pcm-badge--bestseller">Best Seller</span>
       {%- elsif product.tags contains 'Express' -%}
          <!-- Express badge removed per user request, but structure kept for potential future use or other tags -->
       {%- endif -%}
    {%- endif -%}
   {%- assign compare_at_price = product.compare_at_price -%}
   {%- assign money_price = product.price | money -%}
   {%- assign discount_percentage = 0 -%}
   {%- assign has_discount = false -%}

   {%- if compare_at_price > product.price -%}
     {%- assign has_discount = true -%}
     {%- assign discount_percentage = compare_at_price | minus: product.price | times: 100.0 | divided_by: compare_at_price | round -%}
   {%- else -%}
      {%- for tag in product.tags -%}
        {%- if tag contains 'discount_' -%}
           {%- assign has_discount = true -%}
           {%- assign discount_parts = tag | split: '_' -%}
           {%- assign discount_percentage = discount_parts.last | plus: 0 -%}
        {%- endif -%}
      {%- endfor -%}
   {%- endif -%}

   {%- if has_discount -%}
     <div class="pcm-discount-circle">
       <span class="discount-text">-{{ discount_percentage }}%</span>
     </div>
   {%- endif -%}
  </div>

  <!-- PHASE 2: Info Stack -->
  <div class="pcm-info">
    
    <!-- 1. Rating Row -->
    {%- if show_rating -%}
      {%- comment -%} Deterministic Random Rating (4.1-4.9) and Count (1.2k-4.5k) based on Product ID {%- endcomment -%}
      {%- assign rating_int = product.id | modulo: 9 | plus: 41 -%}
      {%- assign rating_val = rating_int | divided_by: 10.0 -%}
      
      {%- assign count_seed = product.id | times: 37 | modulo: 3301 -%}
      {%- assign review_count = 1200 | plus: count_seed -%}
      {%- assign review_count_disp = review_count | divided_by: 100.0 | round | divided_by: 10.0 -%}

      <div class="pcm-rating">
        <span class="pcm-rating-star">â˜…</span>
        <span class="pcm-rating-val">{{ rating_val }}</span>
        <span class="pcm-rating-count">({{ review_count_disp }}k)</span>
      </div>
    {%- endif -%}

    <!-- 2. Title -->
    <h3 class="pcm-title">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    <!-- 3. Price Row -->
    <div class="pcm-price-row">
      <span class="pcm-price-currency">{{ cart.currency.iso_code }}</span>
      <span class="pcm-price-current">{{ product.price | money_without_currency }}</span>
      
      {%- if compare_at_price > product.price -%}
        <!-- Real Discount -->
        <span class="pcm-price-original">{{ compare_at_price | money_without_currency }}</span>
      {%- elsif has_discount and discount_percentage > 0 -%}
        <!-- Tag Based Simulated Original Price -->
        {%- assign inflation_factor = discount_percentage | divided_by: 100.0 -%}
        {%- assign derived_original = product.price | divided_by: 1.0 | divided_by: 0.9 | round: 2 -%} 
        {%- comment -%} Math for reverse discount: Original = Price / (1 - rate) {%- endcomment -%}
        {%- assign rate = 1.0 | minus: inflation_factor -%}
        {%- if rate > 0 -%}
           {%- assign derived_original = product.price | times: 100.0 | divided_by: 100 | divided_by: 1.0 | minus: inflation_factor -%}
           {%- assign oneminus = 100 | minus: discount_percentage -%}
           {%- assign derived_original = product.price | times: 100 | divided_by: oneminus -%}
           <span class="pcm-price-original" style="opacity: 0.6;">{{ derived_original | money_without_currency }}</span>
        {%- endif -%}
      {%- endif -%}
    </div>

    <!-- 4. Urgency (Optional) -->
    <!-- Placeholder for urgency text if needed -->
  </div>

  <!-- PHASE 3: Action Controls -->
  <div class="pcm-action">
    {%- if show_quick_add -%}
      {%- if product.available -%}
        <form method="post" action="/cart/add" class="pcm-form">
          <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
          
          {%- if quick_add_type == 'button' -%}
            <button type="submit" class="pcm-atc-btn pcm-atc-btn--full">Add To Cart</button>
          {%- else -%}
             <button type="submit" class="pcm-atc-btn pcm-atc-btn--icon" aria-label="Add to Cart">
                +
             </button>
          {%- endif -%}
        </form>
      {%- else -%}
        <button class="pcm-atc-btn pcm-atc-btn--disabled" disabled>Sold Out</button>
      {%- endif -%}
    {%- endif -%}
  </div>
</div>

<style>
  .product-card-marketplace {
    background: #fff;
    border-radius: var(--card-radius, 8px);
    border: 1px solid var(--color-border, #e0e0e0);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
    transition: box-shadow 0.2s ease;
  }
  .product-card-marketplace:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Editable shadow strength could be var */
  }

  /* Image Area */
  .pcm-image-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .pcm-image {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Strict requirement */
    padding: 12px;
    mix-blend-mode: multiply;
  }
  
  .pcm-wishlist-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: #fff;
    border: 1px solid #e0e0e0; /* Default border, theme may override */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
    color: #ccc;
  }
  /* Theme overrides for Golden Wishlist */
  .pcm-wishlist-btn svg { width: 14px; height: 14px; stroke: currentColor; fill: none; }

  .pcm-badge {
    position: absolute; top: 8px; left: 8px;
    font-size: 0.6rem; font-weight: 700;
    padding: 2px 6px; border-radius: 4px;
    background: #333; color: #fff;
    z-index: 2;
  }

  /* Info Stack */
  .pcm-info {
    padding: var(--card-padding, 8px) 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-grow: 1;
  }

  /* Rating */
  .pcm-rating { display: flex; align-items: center; gap: 3px; font-size: 0.75rem; color: #666; }
  .pcm-rating-star { color: #FFA41C; font-size: 0.8rem; } /* Default Orange/Gold */
  .pcm-rating-val { font-weight: 700; color: #FFA41C; }

  /* Title */
  .pcm-title {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
    line-height: 1.3;
    height: 2.6em; /* 2 lines */
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .pcm-title a { text-decoration: none; color: inherit; }

  /* Price */
  .pcm-price-row { display: flex; align-items: baseline; flex-wrap: wrap; gap: 4px; margin-top: auto; padding-top: 4px; }
  .pcm-price-currency { font-size: 0.7rem; font-weight: 400; color: inherit; }
  .pcm-price-current { font-size: 1rem; font-weight: 700; }
  .pcm-price-original { font-size: 0.75rem; color: #777; text-decoration: line-through; }
  .pcm-discount-badge { 
    font-size: 0.7rem; font-weight: 700;
    color: #28a745; /* Green default */
    background: #e6f9e9;
    padding: 1px 4px; border-radius: 2px;
  }

  /* Action Area */
  .pcm-action {
    padding: 0 10px 10px 10px;
    min-height: 48px; /* Force height for button alignment */
    display: flex;
    align-items: flex-end;
    opacity: 1 !important;
    visibility: visible !important;
    transform: none !important;
  }
  .pcm-form { width: 100%; }
  
  .pcm-atc-btn {
    width: 100%;
    cursor: pointer;
    border: none;
    opacity: 1 !important;
    visibility: visible !important;
    transition: background 0.3s;
  }
  
  .pcm-atc-btn--full {
     background: var(--color-primary, #000);
     color: #fff;
     padding: 10px 16px;
     border-radius: 50px; /* Fully Rounded (Pill) */
     font-weight: 700;
     font-size: 0.9rem;
     border: 1px solid var(--color-primary, #000);
     text-transform: capitalize;
     letter-spacing: 0.5px;
     transition: all 0.3s ease;
  }
  .pcm-atc-btn--full:hover { 
     background: transparent;
     color: var(--color-primary, #000);
     opacity: 1;
  }

  .pcm-atc-btn--icon {
    width: 32px; height: 32px;
    border-radius: 8px; /* Rounded Square */
    background: #f0f0f0;
    color: #333;
    font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center;
    margin-left: auto; /* Right align if icon */
    transition: all 0.2s;
  }
  .pcm-atc-btn--icon:hover {
    background: var(--color-primary, #000);
    color: #fff;
  }
  
  .pcm-atc-btn--disabled {
    background: #eee; color: #999; cursor: not-allowed; width: 100%; padding: 8px; border-radius: 4px;
  }

  .pcm-discount-circle {
    position: absolute;
    top: 10px;
    right: 10px;
    left: auto;
    width: 38px;
    height: 38px;
    background-color: #ff0000; /* Red Circle */
    color: #ffffff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .discount-text {
    font-size: 0.75rem;
    font-weight: 700;
    line-height: 1;
  }
  
  .pcm-price-original {
    color: #888;
    text-decoration: line-through;
    margin-left: 6px;
    font-size: 0.9rem;
    font-weight: 400;
  }
  
  .pcm-price-current {
    color: #000;
    font-weight: 800;
    font-size: 1.1rem;
  }
</style>
